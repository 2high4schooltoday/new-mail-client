<!doctype html>
<html lang="en" data-theme="machine-dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Despatch</title>
  <meta name="description" content="Lightweight self-hosted web mail client">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="app-shell page-office" id="app-shell">
    <header class="topbar">
      <div class="topbar-row">
        <div class="brand">
          <h1>Despatch</h1>
          <p class="hint">Mail operations console</p>
        </div>
        <nav class="tabs" aria-label="Primary">
          <button id="tab-setup" class="tab" type="button">Setup</button>
          <button id="tab-auth" class="tab active" type="button">Auth</button>
          <button id="tab-mail" class="tab" type="button">Mail</button>
          <button id="tab-admin" class="tab" type="button">Admin</button>
        </nav>
        <div class="topbar-tools">
          <button id="btn-theme" class="cmd-btn cmd-btn--dense theme-toggle" type="button" aria-label="Toggle theme">Theme: Machine</button>
          <button id="btn-logout" class="cmd-btn cmd-btn--dense cmd-btn--ghost" type="button">Sign Out</button>
        </div>
      </div>
    </header>

    <main>
      <section id="status-line" class="status-line" aria-live="polite">Ready</section>

      <section id="view-auth" class="auth-shell">
        <article class="panel auth-panel" aria-labelledby="auth-title">
          <header class="auth-header">
            <h2 id="auth-title">Account Access</h2>
            <p class="hint">Select one action at a time: sign in, request approval, or reset credentials.</p>
          </header>

          <div class="auth-segments" role="tablist" aria-label="Authentication actions">
            <button id="auth-mode-login" class="auth-segment is-active" type="button" role="tab" aria-selected="true" aria-controls="auth-pane-login">Login</button>
            <button id="auth-mode-register" class="auth-segment" type="button" role="tab" aria-selected="false" aria-controls="auth-pane-register">Register</button>
            <button id="auth-mode-reset" class="auth-segment" type="button" role="tab" aria-selected="false" aria-controls="auth-pane-reset">Password Reset</button>
          </div>

          <section id="auth-pane-login" class="auth-pane" role="tabpanel" aria-labelledby="auth-mode-login">
            <form id="form-login" class="stack auth-form">
              <label>Email <input name="email" type="email" required autocomplete="username"></label>
              <label>Password <input name="password" type="password" required autocomplete="current-password"></label>
              <button class="cmd-btn cmd-btn--primary" type="submit">Access Mail</button>
            </form>
          </section>

          <section id="auth-pane-register" class="auth-pane hidden" role="tabpanel" aria-labelledby="auth-mode-register">
            <form id="form-register" class="stack auth-form">
              <label>Email <input name="email" type="email" required autocomplete="email"></label>
              <label>Password <input name="password" type="password" required autocomplete="new-password"></label>
              <div id="captcha-shell" class="captcha-shell hidden">
                <p id="captcha-note" class="hint">Complete the challenge to continue registration.</p>
                <div id="captcha-widget-container" class="captcha-widget-container"></div>
                <label id="captcha-manual-wrap" class="hidden">Captcha Token (manual fallback)<input id="captcha-token-manual" type="text" autocomplete="off"></label>
                <p id="captcha-error" class="hint"></p>
              </div>
              <input id="captcha-token-hidden" name="captcha_token" type="hidden" value="">
              <button class="cmd-btn cmd-btn--primary" type="submit">Submit For Approval</button>
            </form>
          </section>

          <section id="auth-pane-reset" class="auth-pane hidden" role="tabpanel" aria-labelledby="auth-mode-reset">
            <form id="form-reset-request" class="stack auth-form auth-group">
              <h3>Request Token</h3>
              <label>Email <input name="email" type="email" required autocomplete="email"></label>
              <button class="cmd-btn" type="submit">Request Token</button>
            </form>
            <form id="form-reset-confirm" class="stack auth-form auth-group">
              <h3>Apply New Password</h3>
              <label>Reset Token <input name="token" type="text" required autocomplete="one-time-code"></label>
              <label>New Password <input name="new_password" type="password" required autocomplete="new-password"></label>
              <button class="cmd-btn cmd-btn--primary" type="submit">Apply New Password</button>
            </form>
          </section>
        </article>
      </section>

      <section id="view-setup" class="setup-shell hidden page-oobe-assistant">
        <article class="oobe-window" role="region" aria-label="Setup Assistant">
          <header class="oobe-chrome">
            <button id="setup-back-icon" class="oobe-icon-btn" type="button" aria-label="Go to previous step">←</button>
            <p class="oobe-chrome-title">Despatch Setup Assistant</p>
            <button id="setup-close" class="oobe-icon-btn" type="button" aria-label="Cancel setup">×</button>
          </header>

          <form id="form-setup" class="oobe-form" novalidate>
            <div class="oobe-content">
              <div class="oobe-step-indicator" aria-label="Setup progress">
                <span class="oobe-dot active" data-dot="0"></span>
                <span class="oobe-dot" data-dot="1"></span>
                <span class="oobe-dot" data-dot="2"></span>
                <span class="oobe-dot" data-dot="3"></span>
                <span class="oobe-dot" data-dot="4"></span>
                <span class="oobe-dot" data-dot="5"></span>
              </div>

              <div id="setup-step-0" class="oobe-step">
                <div class="oobe-hero-icon" aria-hidden="true">ENTRY</div>
                <h2>Welcome</h2>
                <p>This assistant configures your mail domain, webmaster identity, and first admin credentials. You can complete setup in a few minutes.</p>
                <p class="hint">All settings remain editable from Admin after initialization.</p>
              </div>

              <div id="setup-step-1" class="oobe-step hidden">
                <div class="oobe-hero-icon" aria-hidden="true">REGION</div>
                <h2>Region And Time Profile</h2>
                <p>Set your default region for timestamps and policy localization.</p>
                <label>Region
                  <select id="setup-region" name="region" autocomplete="off">
                    <option value="us-east">United States - East</option>
                    <option value="us-central">United States - Central</option>
                    <option value="us-west">United States - West</option>
                    <option value="eu-west">Europe - West</option>
                    <option value="apac">Asia Pacific</option>
                  </select>
                </label>
                <p class="hint">Timezone mapping follows the selected region profile.</p>
              </div>

              <div id="setup-step-2" class="oobe-step hidden">
                <div class="oobe-hero-icon" aria-hidden="true">DOMAIN</div>
                <h2>Domain And Admin Identity</h2>
                <p>This controls registration domain policy and default webmaster address.</p>
                <label>Mail Domain
                  <input id="setup-domain" name="base_domain" type="text" placeholder="example.com" autocomplete="off">
                </label>
                <label>Admin Email
                  <input id="setup-admin-email" name="admin_email" type="email" autocomplete="email">
                </label>
                <label id="setup-mailbox-login-wrap" class="hidden">Mailbox Login (optional)
                  <input id="setup-admin-mailbox-login" name="admin_mailbox_login" type="text" autocomplete="username" placeholder="e.g. webmaster or system user">
                </label>
                <p class="hint">Default is <code>webmaster@{domain}</code>; you can override it.</p>
              </div>

              <div id="setup-step-3" class="oobe-step hidden">
                <div class="oobe-hero-icon" aria-hidden="true">ADMIN</div>
                <h2>Create Webmaster Credentials</h2>
                <p>Choose a strong password for the first administrator account.</p>
                <label>Password
                  <input id="setup-password" name="admin_password" type="password" autocomplete="new-password">
                </label>
                <label>Verify Password
                  <input id="setup-password-confirm" name="admin_password_confirm" type="password" autocomplete="new-password">
                </label>
                <p id="setup-password-hint" class="hint">Use at least 12 characters and 3 character classes.</p>
              </div>

              <div id="setup-step-4" class="oobe-step hidden">
                <div class="oobe-hero-icon" aria-hidden="true">REVIEW</div>
                <h2>Review And Initialize</h2>
                <div class="oobe-summary-card setup-summary">
                  <div><b>Region:</b> <span id="setup-summary-region">-</span></div>
                  <div><b>Domain:</b> <span id="setup-summary-domain">-</span></div>
                  <div><b>Admin:</b> <span id="setup-summary-email">-</span></div>
                </div>
                <p>Initialize writes your baseline settings and signs in as webmaster.</p>
              </div>

              <div id="setup-step-5" class="oobe-step hidden">
                <div class="oobe-hero-icon" aria-hidden="true">READY</div>
                <h2>Setup Complete</h2>
                <p>Despatch is ready. You can open mailbox view now, or go straight to admin controls.</p>
                <div class="actions">
                  <button id="setup-open-mail" class="cmd-btn cmd-btn--primary" type="button">Open Mail</button>
                  <button id="setup-open-admin" class="cmd-btn" type="button">Open Admin</button>
                </div>
                <p id="setup-complete-note" class="hint">Auto opening mail in 3 seconds.</p>
              </div>
            </div>

            <footer class="oobe-footer">
              <p id="setup-inline-status" class="hint" aria-live="polite"></p>
              <button id="setup-back" class="cmd-btn" type="button">Back</button>
              <button id="setup-next" class="cmd-btn cmd-btn--primary" type="submit">Continue</button>
            </footer>
          </form>
        </article>

        <div id="setup-modal-overlay" class="oobe-modal hidden" aria-hidden="true">
          <div class="oobe-modal-card" role="dialog" aria-modal="true" aria-labelledby="setup-modal-title" aria-describedby="setup-modal-body">
            <h3 id="setup-modal-title">Discard Setup Progress?</h3>
            <p id="setup-modal-body">If you close setup now, initialization stays incomplete and login remains blocked.</p>
            <div class="oobe-modal-actions">
              <button id="setup-modal-cancel" class="cmd-btn" type="button">Keep Editing</button>
              <button id="setup-modal-confirm" class="cmd-btn cmd-btn--primary" type="button">Discard</button>
            </div>
          </div>
        </div>
      </section>

      <section id="view-mail" class="mail-workspace hidden">
        <article class="panel workspace-header">
          <div>
            <h2>Mailbox</h2>
            <p class="hint">Keyboard: Tab pane, j/k row, Enter open, / search, c compose, f flag, s seen, Delete trash.</p>
          </div>
          <div class="actions">
            <button id="mail-mobile-back" class="cmd-btn cmd-btn--dense mail-nav-back" type="button">Back</button>
            <button id="btn-compose-open" class="cmd-btn cmd-btn--primary" type="button">Compose</button>
          </div>
        </article>

        <div class="mail-layout">
          <aside id="mail-pane-mailboxes" class="panel mail-pane mail-pane--mailboxes" tabindex="-1">
            <div class="pane-head">
              <h3>Mailboxes</h3>
            </div>
            <ul id="mailboxes" class="list mailbox-list" role="listbox" aria-label="Mailboxes" tabindex="0"></ul>
          </aside>

          <section id="mail-pane-messages" class="panel mail-pane mail-pane--messages" tabindex="-1">
            <div class="pane-head">
              <h3>Messages</h3>
              <button id="mail-back-to-mailboxes" class="cmd-btn cmd-btn--dense mail-nav-back" type="button">Back</button>
            </div>
            <div class="searchbar">
              <input id="search-input" type="text" placeholder="Search subject, body, sender">
              <button id="btn-search" class="cmd-btn cmd-btn--dense" type="button">Search</button>
            </div>
            <ul id="messages" class="message-list" role="listbox" aria-label="Messages" tabindex="0"></ul>
          </section>

          <section id="mail-pane-reader" class="panel mail-pane mail-pane--reader" tabindex="-1">
            <div class="pane-head">
              <h3>Reader</h3>
              <button id="mail-back-to-messages" class="cmd-btn cmd-btn--dense mail-nav-back" type="button">Back</button>
            </div>
            <div id="message-meta" class="meta"></div>
            <pre id="message-body" class="message-body">Select a message.</pre>
            <div id="attachment-list" class="attachments"></div>
            <div class="actions reader-commands">
              <button id="btn-flag" class="cmd-btn cmd-btn--dense" type="button">Flag</button>
              <button id="btn-mark-seen" class="cmd-btn cmd-btn--dense" type="button">Mark Seen</button>
              <button id="btn-trash" class="cmd-btn cmd-btn--dense cmd-btn--danger" type="button">Move To Trash</button>
            </div>
          </section>
        </div>
      </section>

      <section id="view-admin" class="admin-shell hidden">
        <div class="admin-layout">
          <aside class="panel admin-nav">
            <h2>Admin</h2>
            <button id="admin-nav-update" class="admin-nav-btn is-active" type="button">System</button>
            <button id="admin-nav-registrations" class="admin-nav-btn" type="button">Registrations</button>
            <button id="admin-nav-users" class="admin-nav-btn" type="button">Users</button>
            <button id="admin-nav-audit" class="admin-nav-btn" type="button">Audit Log</button>
          </aside>

          <div class="admin-main">
            <section id="admin-section-update" class="panel admin-section">
              <h3>Software Update</h3>
              <div class="machine-grid">
                <div class="metric-label">Current Version</div><div id="update-current-version" class="metric-value">-</div>
                <div class="metric-label">Current Commit</div><div id="update-current-commit" class="metric-value">-</div>
                <div class="metric-label">Latest Release</div><div id="update-latest-version" class="metric-value">-</div>
                <div class="metric-label">Available</div><div id="update-available" class="metric-value">-</div>
                <div class="metric-label">Last Checked</div><div id="update-last-checked" class="metric-value">-</div>
                <div class="metric-label">Apply State</div><div id="update-apply-state" class="metric-value">idle</div>
              </div>
              <p id="update-note" class="hint">Updates check GitHub Releases and require updater units on Ubuntu.</p>
              <div class="actions">
                <button id="btn-update-check" class="cmd-btn cmd-btn--dense" type="button">Check Now</button>
                <button id="btn-update-apply" class="cmd-btn cmd-btn--primary cmd-btn--dense" type="button">Update</button>
              </div>
            </section>

            <section id="admin-section-registrations" class="panel admin-section hidden">
              <header class="section-head">
                <h3>Registrations</h3>
                <div class="section-tools">
                  <input id="admin-reg-q" type="text" placeholder="Search email or reason">
                  <select id="admin-reg-status">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="all">All</option>
                  </select>
                  <select id="admin-reg-sort">
                    <option value="created_at">Created</option>
                    <option value="email">Email</option>
                    <option value="status">Status</option>
                    <option value="decided_at">Decided</option>
                  </select>
                  <select id="admin-reg-order">
                    <option value="desc">Desc</option>
                    <option value="asc">Asc</option>
                  </select>
                  <button id="btn-admin-reg-apply" class="cmd-btn cmd-btn--dense" type="button">Apply</button>
                </div>
              </header>
              <div class="bulk-bar">
                <button id="btn-reg-select-all" class="cmd-btn cmd-btn--dense cmd-btn--ghost" type="button">Select all</button>
                <button id="btn-reg-clear" class="cmd-btn cmd-btn--dense cmd-btn--ghost" type="button">Clear</button>
                <button id="btn-reg-approve" class="cmd-btn cmd-btn--primary cmd-btn--dense" type="button">Approve selected</button>
                <button id="btn-reg-reject" class="cmd-btn cmd-btn--dense cmd-btn--danger" type="button">Reject selected</button>
              </div>
              <table class="table data-table">
                <thead><tr><th class="num"><input id="admin-reg-check-all" type="checkbox" aria-label="Select all registrations"></th><th>Email</th><th>Status</th><th class="num">Created</th><th>Action</th></tr></thead>
                <tbody id="admin-registrations"></tbody>
              </table>
            </section>

            <section id="admin-section-users" class="panel admin-section hidden">
              <header class="section-head">
                <h3>Users</h3>
                <div class="section-tools">
                  <input id="admin-user-q" type="text" placeholder="Search users">
                  <select id="admin-user-status">
                    <option value="all">All status</option>
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="suspended">Suspended</option>
                  </select>
                  <select id="admin-user-role">
                    <option value="all">All roles</option>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                  </select>
                  <select id="admin-user-provision">
                    <option value="all">All provision</option>
                    <option value="ok">Provisioned</option>
                    <option value="pending">Pending</option>
                    <option value="error">Error</option>
                  </select>
                  <select id="admin-user-sort">
                    <option value="created_at">Created</option>
                    <option value="email">Email</option>
                    <option value="role">Role</option>
                    <option value="status">Status</option>
                    <option value="last_login_at">Last Login</option>
                  </select>
                  <select id="admin-user-order">
                    <option value="desc">Desc</option>
                    <option value="asc">Asc</option>
                  </select>
                  <button id="btn-admin-user-apply" class="cmd-btn cmd-btn--dense" type="button">Apply</button>
                </div>
              </header>
              <div class="bulk-bar">
                <button id="btn-user-select-all" class="cmd-btn cmd-btn--dense cmd-btn--ghost" type="button">Select all</button>
                <button id="btn-user-clear" class="cmd-btn cmd-btn--dense cmd-btn--ghost" type="button">Clear</button>
                <button id="btn-user-suspend" class="cmd-btn cmd-btn--dense cmd-btn--danger" type="button">Suspend selected</button>
                <button id="btn-user-unsuspend" class="cmd-btn cmd-btn--primary cmd-btn--dense" type="button">Unsuspend selected</button>
              </div>
              <table class="table data-table">
                <thead><tr><th class="num"><input id="admin-user-check-all" type="checkbox" aria-label="Select all users"></th><th>Email</th><th>Role</th><th>Status</th><th>Provision</th><th>Action</th></tr></thead>
                <tbody id="admin-users"></tbody>
              </table>
            </section>

            <section id="admin-section-audit" class="panel admin-section hidden">
              <header class="section-head">
                <h3>Audit Log</h3>
                <div class="section-tools">
                  <input id="admin-audit-q" type="text" placeholder="Search action, target, metadata">
                  <select id="admin-audit-action">
                    <option value="all">All actions</option>
                    <option value="registration.approve">Registration approve</option>
                    <option value="registration.reject">Registration reject</option>
                    <option value="user.suspend">User suspend</option>
                    <option value="user.unsuspend">User unsuspend</option>
                    <option value="user.reset_password">User password reset</option>
                    <option value="user.retry_provision">User provision retry</option>
                  </select>
                  <input id="admin-audit-actor" type="text" placeholder="Actor email">
                  <input id="admin-audit-target" type="text" placeholder="Target">
                  <input id="admin-audit-from" type="date">
                  <input id="admin-audit-to" type="date">
                  <select id="admin-audit-sort">
                    <option value="created_at">Created</option>
                    <option value="action">Action</option>
                    <option value="actor">Actor</option>
                    <option value="target">Target</option>
                  </select>
                  <select id="admin-audit-order">
                    <option value="desc">Desc</option>
                    <option value="asc">Asc</option>
                  </select>
                  <button id="btn-admin-audit-apply" class="cmd-btn cmd-btn--dense" type="button">Apply</button>
                </div>
              </header>
              <table class="table data-table">
                <thead><tr><th class="num">When</th><th>Severity</th><th>Summary</th><th>Actor</th><th>Target</th></tr></thead>
                <tbody id="admin-audit"></tbody>
              </table>
            </section>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="compose-overlay" class="compose-overlay hidden" aria-hidden="true">
    <article id="compose-dialog" class="compose-dialog panel" role="dialog" aria-modal="true" aria-labelledby="compose-title">
      <header class="compose-header">
        <h2 id="compose-title">New Message</h2>
        <button id="btn-compose-close" class="cmd-btn" type="button" aria-label="Close compose">Close</button>
      </header>
      <form id="form-compose" class="stack compose-form">
        <label>To (comma separated)<input name="to" type="text" required autocomplete="email"></label>
        <label>Subject<input name="subject" type="text" required autocomplete="off"></label>
        <label>Body<textarea name="body" rows="10" required autocomplete="off"></textarea></label>
        <label class="file-field">Attachments<input name="attachments" type="file" multiple></label>
        <div class="actions compose-actions">
          <button class="cmd-btn" id="btn-compose-cancel" type="button">Cancel</button>
          <button class="cmd-btn cmd-btn--primary" type="submit">Send</button>
        </div>
      </form>
    </article>
  </div>

  <script src="/app.js" defer></script>
</body>
</html>
